// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==========================================
//          USER & ACCESS CONTROL
// ==========================================

model User {
  id         Int      @id @default(autoincrement())
  employeeId String   @unique
  name       String
  email      String   @unique
  password   String // In a real app, this would be a hash
  role       String
  department String
  branch     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Role {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String?
}

// ==========================================
//          BANKING APP USERS
// ==========================================

model AppUser {
  Id               String     @id @unique
  CIFNumber        String     @unique
  FirstName        String?
  SecondName       String?
  LastName         String?
  Email            String?    @unique
  PhoneNumber      String?    @unique
  Status           String?
  Channel          String?
  SignUpMainAuth   String?
  SignUp2FA        String?
  BranchCode       String?
  BranchName       String?
  AddressLine1     String?
  AddressLine2     String?
  AddressLine3     String?
  AddressLine4     String?
  Nationality      String?
  InsertDate       DateTime   @default(now())
  UpdateDate       DateTime   @updatedAt
  UserSecurity     UserSecurity?
}

model Account {
  Id            String  @id @unique
  CIFNumber     String
  AccountNumber String?
  FirstName     String?
  SecondName    String?
  LastName      String?
  AccountType   String?
  Currency      String?
  Status        String?
  BranchName    String?
}

model UserSecurity {
  UserId             String            @id
  User               AppUser           @relation(fields: [UserId], references: [Id])
  CIFNumber          String?           @unique
  Status             String?
  PinHash            String?
  PinSalt            String?
  PasswordHash       String?
  PasswordSalt       String?
  SecurityQuestionId Int?
  SecurityQuestion   SecurityQuestion? @relation(fields: [SecurityQuestionId], references: [Id])
  SecurityAnswer     String?
  LastLoginDate      DateTime?
}

model SecurityQuestion {
  Id        Int            @id @default(autoincrement())
  question  String         @unique
  answers   UserSecurity[]
}

model OtpCode {
    Id         String   @id @default(cuid())
    UserId     String // Typically CIF Number
    Purpose    String // e.g., 'LOGIN', 'TRANSACTION_CONFIRMATION'
    OtpType    String // 'SMS' or 'EMAIL'
    Code       String
    IsUsed     Boolean  @default(false)
    Attempts   Int      @default(0)
    ExpiresAt  DateTime
    InsertDate DateTime @default(now())
    UpdateDate DateTime @updatedAt
}

// ==========================================
//      TRANSACTIONS & PENDING APPROVALS
// ==========================================

// Legacy model for approvals dashboard, to be replaced by AppUser based logic
model Customer {
  id           Int               @id @default(autoincrement())
  name         String
  phone        String            @unique
  status       String
  registeredAt DateTime          @default(now())
  approvals    PendingApproval[]
  transactions Transaction[]
}

model PendingApproval {
  id            String   @id @default(cuid())
  customerId    Int
  customer      Customer @relation(fields: [customerId], references: [id])
  type          String // e.g., 'unblock', 'pin-reset', 'new-customer', 'updated-customer'
  status        String   @default("pending")
  requestedAt   DateTime @default(now())
  approvedBy    String?
  approvedAt    DateTime?
  customerName  String
  customerPhone String
  details       String?  @db.Text
}

model Transaction {
  id             String   @id @default(cuid())
  customerId     Int
  customer       Customer @relation(fields: [customerId], references: [id])
  amount         Float
  fee            Float
  status         String // 'Successful', 'Failed', 'Pending'
  timestamp      DateTime
  type           String // 'P2P', 'Bill Payment', etc.
  channel        String // 'App', 'USSD', etc.
  from_account   String?
  to_account     String
  is_anomalous   Boolean  @default(false)
  anomaly_reason String?
}

// ==========================================
//          BANK STRUCTURE
// ==========================================

model Branch {
  id         String       @id @unique
  name       String       @unique
  location   String
  createdAt  DateTime     @default(now())
  Department Department[]
}

model Department {
  id        String   @id @unique
  name      String   @unique
  branchId  String
  Branch    Branch   @relation(fields: [branchId], references: [id])
  createdAt DateTime @default(now())
}


// ==========================================
//      CORPORATES & MINI APPS
// ==========================================

model Corporate {
  id                      String  @id @unique
  name                    String
  industry                String
  status                  String // e.g., 'Active', 'Inactive'
  internet_banking_status String // e.g., 'Active', 'Pending', 'Disabled'
  logo_url                String?
}


model MiniApp {
  id             String @id @default(cuid())
  name           String @unique
  url            String
  logo_url       String?
  username       String
  password       String
  encryption_key String
}
