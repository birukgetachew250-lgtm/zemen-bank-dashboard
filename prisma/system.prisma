// This is your Prisma schema file for the system database.
// It is separate from your main application's user/admin schema.

datasource db {
  provider = "postgresql"
  url      = env("SYSTEM_MODULE_DB_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// Customer model (for reference, could be in a separate schema)
model Customer {
  id           String            @id @default(cuid())
  name         String
  phone        String            @unique
  status       String // e.g., 'Active', 'Inactive', 'Registered'
  registeredAt DateTime          @default(now())
  transactions Transaction[]
  approvals    PendingApproval[]
}

model Transaction {
  id             String   @id @default(cuid())
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])
  amount         Float
  fee            Float
  status         String // 'Successful', 'Failed', 'Pending'
  timestamp      DateTime
  type           String // e.g., 'P2P', 'Bill Payment'
  channel        String // 'App', 'USSD'
  to_account     String
  is_anomalous   Boolean  @default(false)
  anomaly_reason String?
}

model PendingApproval {
  id            String   @id @default(cuid())
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  type          String // 'new-customer', 'pin-reset', 'unblock-user'
  requestedAt   DateTime @default(now())
  status        String   @default("pending") // 'pending', 'approved', 'rejected'
  details       Json?
  customerName  String
  customerPhone String
}

model AppUser {
  Id               String    @id @default(cuid())
  CIFNumber        String    @unique
  FirstName        String
  SecondName       String?
  LastName         String
  Email            String    @unique
  PhoneNumber      String    @unique
  Status           String
  Channel          String?
  SignUpMainAuth   String
  SignUp2FA        String
  BranchCode       String?
  BranchName       String?
  AddressLine1     String?
  AddressLine2     String?
  AddressLine3     String?
  AddressLine4     String?
  Nationality      String?
  UserSecurity     UserSecurity?
  InsertDate       DateTime  @default(now())
  UpdateDate       DateTime  @updatedAt
}

model Account {
  Id            String    @id @default(cuid())
  CIFNumber     String
  AccountNumber String    @unique
  FirstName     String
  SecondName    String?
  LastName      String
  AccountType   String
  Currency      String
  Status        String
  BranchName    String?
  InsertDate    DateTime  @default(now())
  UpdateDate    DateTime  @updatedAt
}

model UserSecurity {
  Id                   String     @id @default(cuid())
  UserId               String     @unique
  User                 AppUser    @relation(fields: [UserId], references: [Id])
  CIFNumber            String     @unique
  Status               String
  PinHash              String?
  PasswordHash         String?
  SecurityQuestionId   String?
  SecurityQuestion     SecurityQuestion? @relation(fields: [SecurityQuestionId], references: [Id])
  SecurityAnswer       String?
  IncorrectPinAttempts Int        @default(0)
  LastPinChanged       DateTime?
  InsertDate           DateTime   @default(now())
  UpdateDate           DateTime   @updatedAt
}

model SecurityQuestion {
  Id      String   @id @default(cuid())
  Question String  @unique
  UserSecurities UserSecurity[]
}

model OtpCode {
    Id         String   @id @default(cuid())
    UserId     String
    Purpose    String // e.g. LOGIN, TRANSACTION, PIN_RESET
    OtpType    String // e.g. SMS, EMAIL
    Code       String
    IsUsed     Boolean  @default(false)
    Attempts   Int      @default(0)
    ExpiresAt  DateTime
    InsertDate DateTime @default(now())
    UpdateDate DateTime @updatedAt
}
