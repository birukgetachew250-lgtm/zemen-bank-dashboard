
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// System Users, Roles, Branches, Departments
model User {
  id         Int      @id @default(autoincrement())
  employeeId String   @unique
  name       String
  email      String   @unique
  password   String // Hashed in a real app
  role       String
  branch     String?
  department String
  createdAt  DateTime @default(now())
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
}

model Branch {
  id        String       @id @unique
  name      String
  location  String
  createdAt DateTime     @default(now())
  Department Department[]
}

model Department {
  id        String   @id @unique
  name      String
  branchId  String
  branch    Branch   @relation(fields: [branchId], references: [id])
  createdAt DateTime @default(now())
}

// Mini Apps
model MiniApp {
  id             String  @id @default(uuid())
  name           String  @unique
  url            String
  logo_url       String?
  username       String
  password       String
  encryption_key String
}

// App Users & Security
model AppUser {
  Id               String       @id
  CIFNumber        String       @unique
  FirstName        String
  SecondName       String
  LastName         String
  Email            String
  PhoneNumber      String
  Status           String
  SignUpMainAuth   String
  SignUp2FA        String
  BranchCode       String?
  BranchName       String?
  AddressLine1     String?
  AddressLine2     String?
  AddressLine3     String?
  AddressLine4     String?
  Nationality      String?
  Channel          String?
  InsertDate       DateTime     @default(now())
  UpdateDate       DateTime     @updatedAt
  accounts         Account[]
  userSecurity     UserSecurity?
}

model Account {
  Id            String  @id
  CIFNumber     String
  AccountNumber String
  FirstName     String
  SecondName    String
  LastName      String
  AccountType   String
  Currency      String
  Status        String
  BranchCode    String?
  BranchName    String?
  user          AppUser @relation(fields: [CIFNumber], references: [CIFNumber])
  InsertDate    DateTime @default(now())
  UpdateDate    DateTime @updatedAt
}

model UserSecurity {
  Id                 Int      @id @default(autoincrement())
  UserId             String   @unique
  user               AppUser  @relation(fields: [UserId], references: [Id])
  CIFNumber          String   @unique
  Status             String
  PinHash            String?
  PasswordHash       String?
  SecurityQuestionId Int?
  SecurityAnswer     String?
  InsertDate         DateTime @default(now())
  UpdateDate         DateTime @updatedAt
  question           SecurityQuestion? @relation(fields: [SecurityQuestionId], references: [Id])
}

model SecurityQuestion {
  Id        Int      @id @default(autoincrement())
  question  String   @unique
  userSecurities UserSecurity[]
}

model OtpCode {
    Id              String      @id @default(cuid())
    UserId          String
    OtpCode         String
    Purpose         String
    OtpType         String
    IsUsed          Boolean     @default(false)
    Attempts        Int         @default(0)
    ExpiresAt       DateTime
    InsertDate      DateTime    @default(now())
    UpdateDate      DateTime    @updatedAt
}

// Legacy tables for seeding demo data, can be removed later
model Customer {
  id           String          @id @default(cuid())
  name         String
  phone        String          @unique
  status       String
  registeredAt DateTime        @default(now())
  approvals    PendingApproval[]
  transactions Transaction[]
}

model PendingApproval {
  id            String   @id @default(cuid())
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  type          String
  status        String   @default("pending")
  requestedAt   DateTime @default(now())
  customerName  String
  customerPhone String
  details       String?
}

model Transaction {
  id             String     @id @default(cuid())
  customerId     String
  customer       Customer   @relation(fields: [customerId], references: [id])
  amount         Float
  fee            Float
  status         String
  timestamp      DateTime
  type           String
  channel        String
  to_account     String
  is_anomalous   Boolean    @default(false)
  anomaly_reason String?
}

model Corporate {
  id                      String @id @unique
  name                    String
  industry                String
  status                  String
  internet_banking_status String
  logo_url                String?
}
