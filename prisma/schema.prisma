// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("USER_MODULE_DATABASE_URL")
}

model User {
  id         String @id @default(cuid())
  employeeId String @unique
  name       String
  email      String @unique
  password   String
  role       String
  branch     String?
  department String
}

model AppUser {
  id               String      @id @default(cuid())
  cifNumber        String      @unique
  firstName        String?
  secondName       String?
  lastName         String?
  email            String?
  phoneNumber      String?
  addressLine1     String?
  addressLine2     String?
  addressLine3     String?
  addressLine4     String?
  nationality      String?
  branchCode       String?
  branchName       String?
  status           String?
  signUp2FA        String?
  signUpMainAuth   String?
  channel          String?
  insertDate       DateTime    @default(now())
  updateDate       DateTime    @updatedAt
  insertUser       String      @default("system")
  updateUser       String      @default("system")
  version          String      @default(cuid())
  accounts         Account[]
  userSecurity     UserSecurity?
}

model Account {
  id                  String   @id @default(cuid())
  cifNumber           String
  accountNumber       String?
  hashedAccountNumber String?
  firstName           String?
  secondName          String?
  lastName            String?
  branchCode          String?
  branchName          String?
  accountType         String?
  currency            String?
  status              String?
  insertDate          DateTime @default(now())
  updateDate          DateTime @updatedAt
  insertUser          String   @default("system")
  updateUser          String   @default("system")
  version             String   @default(cuid())
  appUser             AppUser  @relation(fields: [cifNumber], references: [cifNumber], onDelete: Cascade)

  @@index([cifNumber])
}

model SecurityQuestion {
  id           String       @id @default(cuid())
  question     String       @unique
  insertDate   DateTime     @default(now())
  updateDate   DateTime     @updatedAt
  insertUser   String       @default("system")
  updateUser   String       @default("system")
  version      String       @default(cuid())
  userSecurities UserSecurity[]
}

model UserSecurity {
  userId                String      @id
  cifNumber             String      @unique
  pinHash               String?
  status                String?
  securityQuestionId    String?
  securityAnswer        String?
  isLoggedIn            Boolean     @default(false)
  failedAttempts        Int         @default(0)
  lastLoginAttempt      DateTime?
  isLocked              Boolean     @default(false)
  unlockedTime          DateTime?
  lockedIntervalMinutes Int?
  encKey                String?
  encIV                 String?
  isBiometricsLogin     Boolean     @default(false)
  isBiometricsPayment   Boolean     @default(false)
  deviceSwitchConsent   Boolean     @default(false)
  onTmpPassword         Boolean     @default(false)
  isActivationUsed      Boolean     @default(false)
  activationExpiredAt   DateTime    @default(now())
  insertDate            DateTime    @default(now())
  updateDate            DateTime    @updatedAt
  insertUser            String      @default("system")
  updateUser            String      @default("system")
  version               String      @default(cuid())
  user                  AppUser     @relation(fields: [userId], references: [id])
  securityQuestion      SecurityQuestion? @relation(fields: [securityQuestionId], references: [id], onDelete: SetNull)

  @@index([securityQuestionId])
}

model OtpCode {
  id         String   @id @default(cuid())
  userId     String?
  codeHash   String?
  secret     String?
  otpType    String?
  purpose    String?
  isUsed     Boolean  @default(false)
  attempts   Int?
  expiresAt  DateTime @default(now())
  insertDate DateTime @default(now())
  updateDate DateTime @updatedAt
  insertUser String   @default("system")
  updateUser String   @default("system")
  version    String?
}

model OtpUser {
  userId      String   @id
  status      Int?
  lockedUntil DateTime @default(now())
  insertDate  DateTime @default(now())
  updateDate  DateTime @updatedAt
  otpCodeId   String?
}

model Customer {
  id             String        @id @default(cuid())
  name           String?
  phone          String?
  status         String?
  registeredAt   DateTime      @default(now())
  approvals      PendingApproval[]
  transactions   Transaction[]
}

model PendingApproval {
  id            String   @id @default(cuid())
  customerId    String?
  type          String?
  requestedAt   DateTime @default(now())
  status        String   @default("pending")
  customerName  String?
  customerPhone String?
  details       String?
  customer      Customer? @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model Transaction {
  id             String    @id @default(cuid())
  customerId     String?
  amount         Float?
  fee            Float?
  status         String?
  timestamp      DateTime  @default(now())
  type           String?
  channel        String?
  to_account     String?
  is_anomalous   Boolean   @default(false)
  anomaly_reason String?
  customer       Customer? @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model Corporate {
  id                      String  @id @default(cuid())
  name                    String?
  industry                String?
  status                  String?
  internet_banking_status String?
  logo_url                String?
}

model Branch {
  id        String   @id @default(cuid())
  name      String
  location  String
  createdAt DateTime @default(now())
  Department Department[]
}

model Department {
  id        String   @id @default(cuid())
  name      String
  branchId  String
  createdAt DateTime @default(now())
  branch    Branch   @relation(fields: [branchId], references: [id])

  @@index([branchId])
}

model MiniApp {
  id             String   @id @default(cuid())
  name           String
  url            String
  logo_url       String?
  username       String
  password       String
  encryption_key String
  createdAt      DateTime @default(now())
}
