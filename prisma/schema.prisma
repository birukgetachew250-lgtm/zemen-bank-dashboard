datasource db {
  provider = "postgresql"
  url      = env("DASH_MODULE_PROD_DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

// Separate client for system-level data, if needed
generator system {
  provider = "prisma-client-js"
  output   = "./system-client"
}

model User {
  id          Int      @id @default(autoincrement())
  employeeId  String   @unique
  name        String
  email       String   @unique
  password    String // In a real app, this would be a hash
  role        String
  branch      String?
  department  String
  mfaEnabled  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Role {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String
}

model Branch {
  id          String       @id @unique
  name        String       @unique
  location    String
  createdAt   DateTime     @default(now())
  departments Department[]
}

model Department {
  id        String   @id @unique
  name      String   @unique
  branch    Branch   @relation(fields: [branchId], references: [id])
  branchId  String
  createdAt DateTime @default(now())
}

model Customer {
  id           Int               @id @default(autoincrement())
  name         String
  phone        String            @unique
  status       String
  registeredAt DateTime          @default(now())
  transactions Transaction[]
  approvals    PendingApproval[]
}

model PendingApproval {
  id            Int      @id @default(autoincrement())
  customerId    Int
  customer      Customer @relation(fields: [customerId], references: [id])
  type          String // e.g. new-customer, pin-reset, suspend
  requestedAt   DateTime @default(now())
  customerName  String
  customerPhone String
  details       String?
  status        String   @default("pending") // pending, approved, rejected
}

model Transaction {
  id             String   @id @default(cuid())
  customerId     Int
  customer       Customer @relation(fields: [customerId], references: [id])
  amount         Float
  fee            Float
  status         String
  timestamp      DateTime @default(now())
  type           String
  channel        String
  from_account   String?
  to_account     String?
  is_anomalous   Boolean  @default(false)
  anomaly_reason String?
}

model Corporate {
  id                      String @id @unique
  name                    String
  industry                String
  status                  String
  internet_banking_status String
  logo_url                String
}

model MiniApp {
  id             String @id @default(cuid())
  name           String
  url            String
  logo_url       String
  username       String
  password       String
  encryption_key String
}

model AppUser {
  Id                  String   @id @default(cuid())
  CIFNumber           String   @unique
  FirstName           String
  SecondName          String?
  LastName            String
  Email               String   @unique
  PhoneNumber         String   @unique
  PhoneNumberHashed   String   @unique
  AddressLine1        String?
  AddressLine2        String?
  AddressLine3        String?
  AddressLine4        String?
  Nationality         String?
  BranchCode          String?
  BranchName          String?
  Status              String
  SignUp2FA           String?
  SignUpMainAuth      String?
  Channel             String?
  InsertDate          DateTime @default(now())
  UpdateDate          DateTime @updatedAt
  InsertUser          String   @default("system")
  UpdateUser          String   @default("system")
  Version             String   @default(cuid())
}

model Account {
  Id                  String   @id @default(cuid())
  CIFNumber           String
  AccountNumber       String   @unique
  HashedAccountNumber String   @unique
  FirstName           String
  SecondName          String?
  LastName            String
  BranchCode          String?
  BranchName          String?
  AccountType         String
  Currency            String
  Status              String
  InsertDate          DateTime @default(now())
  UpdateDate          DateTime @updatedAt
  InsertUser          String   @default("system")
  UpdateUser          String   @default("system")
  Version             String   @default(cuid())
}

model UserSecurity {
  Id                  String   @id @default(cuid())
  UserId              String   @unique
  CIFNumber           String   @unique
  Status              String
  PinHash             String?
  SecurityQuestionId  Int?
  SecurityAnswer      String?
  IsLoggedIn          Boolean  @default(false)
  FailedAttempts      Int      @default(0)
  LastLoginAttempt    DateTime?
  IsLocked            Boolean  @default(false)
  UnlockedTime        DateTime?
  LockedIntervalMinutes Int    @default(0)
  EncKey              String?
  EncIV               String?
  IsBiometricsLogin   Boolean  @default(false)
  IsBiometricsPayment Boolean  @default(false)
  DeviceSwitchConsent Boolean  @default(true)
  OnTmpPassword       Boolean  @default(false)
  IsActivationUsed    Boolean  @default(false)
  ActivationExpiredAt DateTime?
  InsertDate          DateTime @default(now())
  UpdateDate          DateTime @updatedAt
  InsertUser          String   @default("system")
  UpdateUser          String   @default("system")
  Version             String   @default(cuid())
}


model SecurityQuestion {
  id       Int    @id @default(autoincrement())
  question String @unique
}


model OtpCode {
  Id         Int      @id @default(autoincrement())
  Purpose    String
  UserId     String
  OtpType    String
  Code       String?
  IsUsed     Boolean  @default(false)
  ExpiresAt  DateTime
  Attempts   Int      @default(0)
  InsertDate DateTime @default(now())
  UpdateDate DateTime @updatedAt
}

model IPSBank {
  id                    String   @id @default(cuid())
  bankName              String   @unique
  bankCode              String   @unique
  reconciliationAccount String
  bankLogo              String?
  status                String
  rank                  Int
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Integration {
  id            Int     @id @default(autoincrement())
  name          String  @unique
  service       String
  endpointUrl   String
  username      String?
  password      String?
  status        String
  isProduction  Boolean @default(false)
}

model SecurityPolicy {
  id                  Int      @id @default(1)
  mfaRequired         Boolean  @default(true)
  allowedMfaMethods   String[]
  sessionTimeout      Int      @default(30)
  concurrentSessions  Int      @default(1)
}

model IpWhitelist {
  id        Int      @id @default(autoincrement())
  cidr      String   @unique
  label     String
  createdAt DateTime @default(now())
}

model SystemActivityLog {
  id          Int      @id @default(autoincrement())
  timestamp   DateTime @default(now())
  userEmail   String
  action      String
  status      String
  details     String?
  ipAddress   String?
}

model LimitRule {
  Id                 String    @id @default(uuid()) @map("Id") @db.VarChar(36)
  CustomerCategory   String?   @map("CustomerCategory") @db.VarChar(100)
  TransactionType    String?   @map("TransactionType") @db.VarChar(100)
  DailyLimit         Decimal?  @db.Decimal(18, 6) @map("DailyLimit")
  WeeklyLimit        Decimal?  @db.Decimal(18, 6) @map("WeeklyLimit")
  MonthlyLimit       Decimal?  @db.Decimal(18, 6) @map("MonthlyLimit")
  Currency           String?   @map("Currency") @db.VarChar(10)
  EffectiveFrom      DateTime  @default(now()) @map("EffectiveFrom")
  EffectiveTo        DateTime? @map("EffectiveTo")
  IsActive           Boolean   @default(false) @map("IsActive")
  InsertDate         DateTime  @default(now()) @map("InsertDate")
  UpdateDate         DateTime  @updatedAt @map("UpdateDate")
  InsertUser         String    @default("system") @map("InsertUser") @db.VarChar(50)
  UpdateUser         String    @default("system") @map("UpdateUser") @db.VarChar(50)
  Version            String    @default(cuid()) @map("Version")
  customerTransactions LimitCustomerTransaction[]

  @@map("LimitRules")
}

model LimitException {
  Id                     String    @id @default(uuid()) @map("Id") @db.VarChar(36)
  EncryptedAccountNumber String    @map("EncryptedAccountNumber") @db.VarChar(500)
  AdditionalDailyLimit   Decimal?  @db.Decimal(18, 6) @map("AdditionalDailyLimit")
  AdditionalWeeklyLimit  Decimal?  @db.Decimal(18, 6) @map("AdditionalWeeklyLimit")
  AdditionalMonthlyLimit Decimal?  @db.Decimal(18, 6) @map("AdditionalMonthlyLimit")
  IsOverride             Boolean   @default(false) @map("IsOverride")
  Reason                 String?   @map("Reason") @db.VarChar(500)
  EffectiveFrom          DateTime  @default(now()) @map("EffectiveFrom")
  EffectiveTo            DateTime? @map("EffectiveTo")
  IsActive               Boolean   @default(false) @map("IsActive")
  InsertDate             DateTime  @default(now()) @map("InsertDate")
  UpdateDate             DateTime  @updatedAt @map("UpdateDate")
  InsertUser             String    @default("system") @map("InsertUser") @db.VarChar(50)
  UpdateUser             String    @default("system") @map("UpdateUser") @db.VarChar(50)
  Version                String    @default(cuid()) @map("Version")
  customerTransactions   LimitCustomerTransaction[]

  @@map("LimitExceptions")
}

model LimitCustomerTransaction {
  Id                 String    @id @default(uuid()) @map("Id") @db.VarChar(36)
  CIFNumber          String?   @map("CIFNumber") @db.VarChar(25)
  EncryptedAccountNumber String @map("EncryptedAccountNumber") @db.VarChar(500)
  TransactionType    String?   @map("TransactionType") @db.VarChar(100)
  ServiceName        String?   @map("ServiceName") @db.VarChar(200)
  Amount             Decimal   @db.Decimal(18, 6) @map("Amount")
  Currency           String?   @map("Currency") @db.VarChar(10)
  TransactionDate    DateTime  @default(now()) @map("TransactionDate")
  IsApproved         Boolean   @default(false) @map("IsApproved")
  AppliedLimitRuleId String?   @map("AppliedLimitRuleId") @db.VarChar(36)
  AppliedExceptionId String?   @map("AppliedExceptionId") @db.VarChar(36)
  CalculatedCharge   Decimal?  @db.Decimal(18, 6) @map("CalculatedCharge")
  ValidationComment  String?   @map("ValidationComment") @db.VarChar(2000)
  InsertDate         DateTime  @default(now()) @map("InsertDate")
  UpdateDate         DateTime  @updatedAt @map("UpdateDate")
  InsertUser         String    @default("system") @map("InsertUser") @db.VarChar(50)
  UpdateUser         String    @default("system") @map("UpdateUser") @db.VarChar(50)
  Version            String    @default(cuid()) @map("Version")
  
  AppliedLimitRule   LimitRule?      @relation(fields: [AppliedLimitRuleId], references: [Id], onDelete: NoAction, onUpdate: NoAction)
  AppliedException   LimitException? @relation(fields: [AppliedExceptionId], references: [Id], onDelete: NoAction, onUpdate: NoAction)

  @@map("CustomerTransactions")
}

model ChargeRule {
  Id                 String    @id @default(uuid()) @map("Id") @db.VarChar(36)
  CustomerCategory   String?   @map("CustomerCategory") @db.VarChar(100)
  TransactionType    String?   @map("TransactionType") @db.VarChar(100)
  ServiceName        String?   @map("ServiceName") @db.VarChar(200)
  Percentage         Decimal   @db.Decimal(18, 6) @map("Percentage")
  FixedAmount        Decimal   @db.Decimal(18, 6) @map("FixedAmount")
  EffectiveFrom      DateTime  @default(now()) @map("EffectiveFrom")
  EffectiveTo        DateTime? @map("EffectiveTo")
  IsActive           Boolean   @default(false) @map("IsActive")
  InsertDate         DateTime  @default(now()) @map("InsertDate")
  UpdateDate         DateTime  @updatedAt @map("UpdateDate")
  InsertUser         String    @default("system") @map("InsertUser") @db.VarChar(50)
  UpdateUser         String    @default("system") @map("UpdateUser") @db.VarChar(50)
  Version            String    @default(cuid()) @map("Version")

  @@map("ChargeRules")
}
