
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// ================================================= //
//                USER & AUTH MODELS                 //
// ================================================= //

model User {
  id         Int      @id @default(autoincrement())
  employeeId String   @unique
  name       String
  email      String   @unique
  password   String // Hashed in a real application
  role       String
  department String
  branch     String?
}

model Role {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String
}

// ================================================= //
//             APP USER & CUSTOMER MODELS            //
// ================================================= //

model AppUser {
  Id                  String          @id @unique
  CIFNumber           String          @unique
  FirstName           String?
  SecondName          String?
  LastName            String?
  Email               String?
  PhoneNumber         String?
  Status              String?
  SignUpDate          DateTime?       @default(now())
  LastLoginDate       DateTime?
  LastLoginIp         String?
  LastLoginDevice     String?
  SignUpMainAuth      String?
  SignUp2FA           String?
  InsertDate          DateTime        @default(now())
  UpdateDate          DateTime?       @updatedAt
  BranchCode          String?
  BranchName          String?
  AddressLine1        String?
  AddressLine2        String?
  AddressLine3        String?
  AddressLine4        String?
  Nationality         String?
  Channel             String?
  userSecurity        UserSecurity?
}

model Account {
  Id            String  @id @unique
  CIFNumber     String
  AccountNumber String
  FirstName     String?
  SecondName    String?
  LastName      String?
  AccountType   String?
  Currency      String?
  Status        String?
  BranchName    String?
  BranchCode    String?

  @@index([CIFNumber])
}

model UserSecurity {
  Id                 String            @id @default(cuid())
  UserId             String            @unique
  user               AppUser           @relation(fields: [UserId], references: [Id])
  CIFNumber          String            @unique
  Status             String?
  PinHash            String?
  PasswordHash       String?
  SecurityQuestionId Int?
  SecurityAnswer     String?
  securityQuestion   SecurityQuestion? @relation(fields: [SecurityQuestionId], references: [Id])

  @@index([UserId])
}

model SecurityQuestion {
  Id      Int            @id @default(autoinchour())
  question String
  answers UserSecurity[]
}

model OtpCode {
    Id         String   @id @default(cuid())
    UserId     String
    Purpose    String
    OtpType    String // SMS, EMAIL, GAUTH
    Code       String // Encrypted
    IsUsed     Boolean  @default(false)
    Attempts   Int      @default(0)
    ExpiresAt  DateTime
    InsertDate DateTime @default(now())
    UpdateDate DateTime @updatedAt
}


// ================================================= //
//               LEGACY & MOCK MODELS                //
// ================================================= //
// These models are for local seeding and might not  //
// reflect the final microservice architecture.      //
// ================================================= //

model Customer {
  id             Int               @id @default(autoinchour())
  name           String
  phone          String            @unique
  status         String
  registeredAt   DateTime          @default(now())
  transactions   Transaction[]
  pendingApprovals PendingApproval[]
}

model PendingApproval {
  id             Int      @id @default(autoinchour())
  customerId     Int
  customer       Customer @relation(fields: [customerId], references: [id])
  type           String // e.g., 'unblock', 'pin-reset', 'new-customer'
  requestedAt    DateTime @default(now())
  status         String   @default("pending") // pending, approved, rejected
  details        String?  // JSON string for extra info
  customerName   String
  customerPhone  String
}

model Transaction {
  id             String    @id @default(cuid())
  customerId     Int
  customer       Customer  @relation(fields: [customerId], references: [id])
  amount         Float
  fee            Float
  status         String
  timestamp      DateTime
  type           String
  channel        String
  to_account     String
  is_anomalous   Boolean   @default(false)
  anomaly_reason String?
}


// ================================================= //
//              STRUCTURE & SETTINGS                 //
// ================================================= //

model Branch {
  id          String       @id @unique
  name        String       @unique
  location    String
  createdAt   DateTime     @default(now())
  departments Department[]
}

model Department {
  id        String @id @unique
  name      String @unique
  branchId  String
  branch    Branch @relation(fields: [branchId], references: [id])
  createdAt DateTime @default(now())
}

model Corporate {
    id                      String @id @unique
    name                    String
    industry                String
    status                  String
    internet_banking_status String
    logo_url                String
}

model MiniApp {
    id              String @id @default(cuid())
    name            String
    url             String
    logo_url        String
    username        String
    password        String
    encryption_key  String
}
