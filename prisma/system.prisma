// datasource "system" is for the core system data like customers, transactions, etc.
datasource system {
  provider = "postgresql"
  url      = env("SYSTEM_MODULE_DB_URL")
}

generator system {
  provider      = "prisma-client-js"
  output        = "../node_modules/@prisma/client/system"
  binaryTargets = ["native"]
}

model AppUser {
  Id               String   @id
  CIFNumber        String   @unique
  FirstName        String?
  SecondName       String?
  LastName         String?
  Email            String?
  PhoneNumber      String?
  Status           String
  SignUpMainAuth   String?
  SignUp2FA        String?
  AddressLine1     String?
  AddressLine2     String?
  AddressLine3     String?
  AddressLine4     String?
  Nationality      String?
  BranchCode       String?
  BranchName       String?
  UserSecurity     UserSecurity?
  InsertDate       DateTime @default(now())
  UpdateDate       DateTime @updatedAt
  Channel          String?

  @@map("AppUser")
}

model Account {
  Id            String  @id
  CIFNumber     String
  AccountNumber String? @unique
  FirstName     String?
  SecondName    String?
  LastName      String?
  AccountType   String?
  Currency      String?
  Status        String?
  BranchName    String?

  @@map("Account")
}

model SecurityQuestion {
  id    String @id @default(uuid())
  question String
  userSecurities UserSecurity[]

  @@map("SecurityQuestion")
}

model UserSecurity {
  UserId             String @id
  CIFNumber          String @unique
  Status             String
  PinHash            String?
  PasswordHash       String?
  SecurityQuestionId String?
  SecurityAnswer     String?
  
  user AppUser @relation(fields: [UserId], references: [Id])
  securityQuestion SecurityQuestion? @relation(fields: [SecurityQuestionId], references: [id])

  @@map("UserSecurity")
}

model OtpCode {
  Id         String   @id
  Purpose    String
  OtpType    String
  OtpCode    String
  Attempts   Int
  IsUsed     Boolean
  UserId     String
  InsertDate DateTime @default(now())
  UpdateDate DateTime @updatedAt
  ExpiresAt  DateTime

  @@map("OtpCode")
}

model Transaction {
  id             String    @id @default(uuid())
  timestamp      DateTime
  type           String
  amount         Float
  fee            Float
  status         String
  channel        String
  from_account   String?
  to_account     String?
  is_anomalous   Boolean   @default(false)
  anomaly_reason String?
  customerId     String
  customer       Customer  @relation(fields: [customerId], references: [id])
}

model Customer {
  id            String    @id @default(uuid())
  name          String
  phone         String    @unique
  status        String
  registeredAt  DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  transactions  Transaction[]
  pendingApprovals PendingApproval[]
}

model PendingApproval {
  id            String   @id @default(uuid())
  type          String
  status        String   @default("pending")
  requestedAt   DateTime @default(now())
  resolvedAt    DateTime?
  customerName  String
  customerPhone String
  details       Json?
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
}

model Corporate {
  id                      String  @id
  name                    String
  industry                String
  status                  String
  internet_banking_status String
  logo_url                String
}
